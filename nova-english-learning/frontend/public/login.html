<!doctype html>
<html>
  <head>
    <title>SPEAK-SEE-PIC!- Login</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="/css/global.css" />
    <script src="https://sdk.amazonaws.com/js/aws-sdk-2.1.24.min.js"></script>
    <script src="https://unpkg.com/amazon-cognito-identity-js@6.3.12/dist/amazon-cognito-identity.min.js"></script>
    <script src="/js/cognito-config.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .login-container {
        max-width: 400px;
        width: 90%;
        padding: 40px;
        background: white;
        border-radius: 16px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
      }

      .logo {
        text-align: center;
        margin-bottom: 30px;
      }

      .logo h1 {
        color: #667eea;
        font-size: 32px;
        font-weight: 700;
        margin-bottom: 8px;
      }

      .logo p {
        color: #666;
        font-size: 14px;
      }

      .form-group {
        margin-bottom: 20px;
      }

      .form-group label {
        display: block;
        margin-bottom: 8px;
        color: #333;
        font-weight: 500;
        font-size: 14px;
      }

      .form-group input {
        width: 100%;
        padding: 14px 16px;
        border: 2px solid #e1e5e9;
        border-radius: 8px;
        font-size: 16px;
        transition: all 0.3s ease;
      }

      .form-group input:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      }

      .login-btn {
        width: 100%;
        padding: 14px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-bottom: 20px;
      }

      .login-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
      }

      .login-btn:disabled {
        background: #ccc;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }

      .signup-link {
        text-align: center;
      }

      .signup-link a {
        color: #667eea;
        text-decoration: none;
        font-weight: 500;
      }

      .error-message {
        background: #fee;
        color: #c33;
        padding: 12px;
        border-radius: 8px;
        margin-bottom: 20px;
        display: none;
        font-size: 14px;
      }

      .signup-form {
        display: none;
      }

      .form-toggle {
        text-align: center;
        margin-top: 20px;
      }

      .form-toggle a {
        color: #667eea;
        text-decoration: none;
        font-weight: 500;
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <div class="login-container">
      <div class="logo">
        <h1>SPEAK-SEE-PIC!</h1>
        <p>AI-Powered Image Description Learning</p>
      </div>

      <div id="error-message" class="error-message"></div>

      <!-- 로그인 폼 -->
      <div id="login-form-container">
        <form id="login-form">
          <div class="form-group">
            <label for="email">Email</label>
            <input
              type="email"
              id="email"
              name="email"
              placeholder="Enter your email"
              required
            />
          </div>
          <div class="form-group">
            <label for="password">Password</label>
            <input
              type="password"
              id="password"
              name="password"
              placeholder="Enter your password"
              required
            />
          </div>
          <button type="submit" class="login-btn" id="login-btn">Sign In</button>
        </form>
        
        <div class="form-toggle">
          <p>Don't have an account? <a onclick="showSignUp()">Sign up</a></p>
        </div>
      </div>

      <!-- 회원가입 폼 -->
      <div id="signup-form-container" class="signup-form">
        <form id="signup-form">
          <div class="form-group">
            <label for="signup-email">Email</label>
            <input
              type="email"
              id="signup-email"
              name="email"
              placeholder="Enter your email"
              required
            />
          </div>
          <div class="form-group">
            <label for="signup-password">Password</label>
            <input
              type="password"
              id="signup-password"
              name="password"
              placeholder="Enter your password (min 8 characters)"
              required
            />
          </div>
          <div class="form-group">
            <label for="confirm-password">Confirm Password</label>
            <input
              type="password"
              id="confirm-password"
              name="confirmPassword"
              placeholder="Confirm your password"
              required
            />
          </div>
          <button type="submit" class="login-btn" id="signup-btn">Sign Up</button>
        </form>
        
        <div class="form-toggle">
          <p>Already have an account? <a onclick="showLogin()">Sign in</a></p>
        </div>
      </div>

      <!-- 이메일 확인 폼 -->
      <div id="verify-form-container" class="signup-form">
        <h3 style="text-align: center; margin-bottom: 20px; color: #667eea;">Verify Your Email</h3>
        <p style="text-align: center; margin-bottom: 20px; color: #666;">
          We've sent a verification code to your email. Please enter it below.
        </p>
        <form id="verify-form">
          <div class="form-group">
            <label for="verification-code">Verification Code</label>
            <input
              type="text"
              id="verification-code"
              name="code"
              placeholder="Enter verification code"
              required
            />
          </div>
          <button type="submit" class="login-btn" id="verify-btn">Verify</button>
        </form>
        
        <div class="form-toggle">
          <p><a onclick="resendCode()">Resend code</a></p>
        </div>
      </div>
    </div>

    <script>
      let currentUser = null;

      // 로그인 폼 처리
      document.getElementById("login-form").addEventListener("submit", async (e) => {
        e.preventDefault();
        
        const email = document.getElementById("email").value;
        const password = document.getElementById("password").value;
        const loginBtn = document.getElementById("login-btn");
        
        loginBtn.disabled = true;
        loginBtn.textContent = "Signing in...";
        
        try {
          await signIn(email, password);
        } catch (error) {
          showError(error.message);
        } finally {
          loginBtn.disabled = false;
          loginBtn.textContent = "Sign In";
        }
      });

      // 회원가입 폼 처리
      document.getElementById("signup-form").addEventListener("submit", async (e) => {
        e.preventDefault();
        
        const email = document.getElementById("signup-email").value;
        const password = document.getElementById("signup-password").value;
        const confirmPassword = document.getElementById("confirm-password").value;
        const signupBtn = document.getElementById("signup-btn");
        
        if (password !== confirmPassword) {
          showError("Passwords do not match");
          return;
        }
        
        if (password.length < 8) {
          showError("Password must be at least 8 characters long");
          return;
        }
        
        signupBtn.disabled = true;
        signupBtn.textContent = "Signing up...";
        
        try {
          await signUp(email, password);
        } catch (error) {
          showError(error.message);
        } finally {
          signupBtn.disabled = false;
          signupBtn.textContent = "Sign Up";
        }
      });

      // 이메일 확인 폼 처리
      document.getElementById("verify-form").addEventListener("submit", async (e) => {
        e.preventDefault();
        
        const code = document.getElementById("verification-code").value;
        const verifyBtn = document.getElementById("verify-btn");
        
        verifyBtn.disabled = true;
        verifyBtn.textContent = "Verifying...";
        
        try {
          await confirmSignUp(code);
        } catch (error) {
          showError(error.message);
        } finally {
          verifyBtn.disabled = false;
          verifyBtn.textContent = "Verify";
        }
      });

      // Cognito 로그인
      function signIn(email, password) {
        return new Promise((resolve, reject) => {
          const authenticationData = {
            Username: email,
            Password: password,
          };
          
          const authenticationDetails = new AmazonCognitoIdentity.AuthenticationDetails(authenticationData);
          
          const userData = {
            Username: email,
            Pool: userPool,
          };
          
          const cognitoUser = new AmazonCognitoIdentity.CognitoUser(userData);
          
          cognitoUser.authenticateUser(authenticationDetails, {
            onSuccess: (result) => {
              localStorage.setItem("user", JSON.stringify({
                email: email,
                name: email.split("@")[0],
                accessToken: result.getAccessToken().getJwtToken()
              }));
              window.location.href = "/categories.html";
              resolve(result);
            },
            onFailure: (err) => {
              reject(err);
            }
          });
        });
      }

      // Cognito 회원가입
      function signUp(email, password) {
        return new Promise((resolve, reject) => {
          const attributeList = [];
          
          const dataEmail = {
            Name: 'email',
            Value: email,
          };
          
          const attributeEmail = new AmazonCognitoIdentity.CognitoUserAttribute(dataEmail);
          attributeList.push(attributeEmail);
          
          userPool.signUp(email, password, attributeList, null, (err, result) => {
            if (err) {
              reject(err);
              return;
            }
            
            currentUser = result.user;
            document.getElementById("signup-form-container").style.display = "none";
            document.getElementById("verify-form-container").style.display = "block";
            resolve(result);
          });
        });
      }

      // 이메일 확인
      function confirmSignUp(code) {
        return new Promise((resolve, reject) => {
          if (!currentUser) {
            reject(new Error("No user to confirm"));
            return;
          }
          
          currentUser.confirmRegistration(code, true, (err, result) => {
            if (err) {
              reject(err);
              return;
            }
            
            showLogin();
            showError("Account verified! Please sign in.");
            resolve(result);
          });
        });
      }

      // 확인 코드 재전송
      function resendCode() {
        if (!currentUser) {
          showError("No user to resend code to");
          return;
        }
        
        currentUser.resendConfirmationCode((err, result) => {
          if (err) {
            showError(err.message);
            return;
          }
          showError("Verification code resent!");
        });
      }

      // UI 전환 함수들
      function showSignUp() {
        document.getElementById("login-form-container").style.display = "none";
        document.getElementById("signup-form-container").style.display = "block";
        document.getElementById("verify-form-container").style.display = "none";
        clearError();
      }

      function showLogin() {
        document.getElementById("login-form-container").style.display = "block";
        document.getElementById("signup-form-container").style.display = "none";
        document.getElementById("verify-form-container").style.display = "none";
        clearError();
      }

      function showError(message) {
        const errorDiv = document.getElementById("error-message");
        errorDiv.textContent = message;
        errorDiv.style.display = "block";
      }

      function clearError() {
        const errorDiv = document.getElementById("error-message");
        errorDiv.style.display = "none";
      }

      // 이미 로그인된 경우 카테고리 페이지로 리다이렉트
      if (localStorage.getItem("user")) {
        window.location.href = "/categories.html";
      }
    </script>
  </body>
</html>
