<!doctype html>
<html>
  <head>
    <title>SPEAK-SEE-PIC! - Study</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="/css/global.css" />
    <script src="/socket.io/socket.io.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        background: #fafafa;
        min-height: 100vh;
        position: relative;
        overflow-x: hidden;
      }

      .floating-orb {
        position: fixed;
        border-radius: 50%;
        filter: blur(30px);
        opacity: 0.6;
        pointer-events: none;
        z-index: -1;
        animation: float 25s infinite ease-in-out;
      }

      .orb-1 {
        width: 400px;
        height: 400px;
        background: linear-gradient(135deg, #ffb3a7, #ff8a95);
        top: 5%;
        left: -15%;
        animation-delay: 0s;
      }

      .orb-2 {
        width: 280px;
        height: 280px;
        background: linear-gradient(135deg, #e8d5ff, #c4b5fd);
        bottom: 10%;
        right: -10%;
        animation-delay: -8s;
      }

      .orb-3 {
        width: 180px;
        height: 180px;
        background: linear-gradient(135deg, #b8e0ff, #93c5fd);
        top: 15%;
        right: 20%;
        animation-delay: -16s;
      }

      @keyframes float {
        0%,
        100% {
          transform: translateY(0px) translateX(0px);
        }
        25% {
          transform: translateY(-20px) translateX(10px);
        }
        50% {
          transform: translateY(10px) translateX(-15px);
        }
        75% {
          transform: translateY(-15px) translateX(5px);
        }
      }

      .header {
        background: transparent;
        padding: 25px 0;
        margin-bottom: 40px;
      }

      .header-content {
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .logo h1 {
        color: #667eea;
        font-size: 28px;
        font-weight: 800;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .session-info {
        display: flex;
        align-items: center;
        gap: 20px;
      }

      .timer {
        color: #64748b;
        font-weight: 600;
        background: rgba(255, 255, 255, 0.8);
        backdrop-filter: blur(10px);
        padding: 6px 12px;
        border-radius: 8px;
        border: 1px solid rgba(255, 255, 255, 0.3);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      }

      .back-btn {
        padding: 8px 16px;
        background: rgba(255, 255, 255, 0.8);
        backdrop-filter: blur(10px);
        color: #4c1d95;
        border: 1px solid rgba(255, 255, 255, 0.3);
        border-radius: 8px;
        cursor: pointer;
        text-decoration: none;
        font-weight: 600;
        transition: all 0.3s ease;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      }

      .back-btn:hover {
        background: #f8fafc;
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 20px;
      }

      .page-title {
        text-align: center;
        margin-bottom: 40px;
      }

      .page-title h2 {
        font-size: 36px;
        color: #1e293b;
        margin-bottom: 15px;
        font-weight: 800;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .page-title p {
        font-size: 20px;
        color: #475569;
        font-weight: 500;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
      }

      .study-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 20px;
        height: calc(100vh - 200px);
      }

      .left-panel {
        display: flex;
        flex-direction: column;
        gap: 20px;
      }

      .center-panel {
        display: flex;
        flex-direction: column;
        gap: 20px;
      }

      .right-panel {
        display: flex;
        flex-direction: column;
        gap: 20px;
      }

      .image-section {
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(15px);
        border-radius: 16px;
        padding: 24px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        border: 1px solid rgba(255, 255, 255, 0.3);
        transition: all 0.3s ease;
      }

      .image-section:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
      }

      .section-title {
        font-size: 18px;
        font-weight: 700;
        background: linear-gradient(135deg, #1e293b 0%, #667eea 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        margin-bottom: 15px;
        filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));
      }

      .original-image {
        width: 100%;
        border-radius: 16px;
        margin-bottom: 15px;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        border: 2px solid rgba(255, 255, 255, 0.3);
        transition: all 0.3s ease;
      }

      .original-image:hover {
        transform: scale(1.02);
        box-shadow: 0 12px 35px rgba(0, 0, 0, 0.2);
      }

      .image-info {
        background: #f8fafc;
        padding: 15px;
        border-radius: 12px;
        font-size: 14px;
        color: #475569;
        border: 1px solid #e2e8f0;
      }

      .generated-image-section {
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(15px);
        border-radius: 16px;
        padding: 24px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        border: 1px solid rgba(255, 255, 255, 0.3);
        flex: 1;
        transition: all 0.3s ease;
      }

      .generated-image-section:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
      }

      .generated-image-placeholder {
        width: 100%;
        height: 300px;
        background: #f8fafc;
        border: 2px dashed #cbd5e1;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #64748b;
        font-size: 16px;
        text-align: center;
        padding: 20px;
      }

      .generated-image {
        width: 100%;
        border-radius: 16px;
        display: none;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        border: 2px solid rgba(255, 255, 255, 0.3);
        transition: all 0.3s ease;
      }

      .generated-image:hover {
        transform: scale(1.02);
        box-shadow: 0 12px 35px rgba(0, 0, 0, 0.2);
      }

      .conversation-section {
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(15px);
        border-radius: 16px;
        padding: 24px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        border: 1px solid rgba(255, 255, 255, 0.3);
        flex: 1;
        display: flex;
        flex-direction: column;
        transition: all 0.3s ease;
      }

      .conversation-section:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
      }

      .chat-container {
        flex: 1;
        overflow-y: auto;
        margin-bottom: 20px;
        max-height: 400px;
        background: #f8fafc;
        border-radius: 12px;
        padding: 16px;
        border: 1px solid #e2e8f0;
      }

      .message {
        margin-bottom: 15px;
        padding: 12px 16px;
        border-radius: 12px;
        max-width: 80%;
      }

      .message.user {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        margin-left: auto;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        border: 1px solid rgba(255, 255, 255, 0.2);
      }

      .message.assistant {
        background: white;
        color: #1e293b;
        border: 1px solid #e2e8f0;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      }

      .message.thinking {
        background: #fef3c7;
        color: #92400e;
        font-style: italic;
        border: 1px solid #fde68a;
        box-shadow: 0 2px 8px rgba(146, 64, 14, 0.1);
      }

      .role-label {
        font-size: 12px;
        font-weight: 600;
        margin-bottom: 4px;
        opacity: 0.7;
      }

      .controls-section {
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(15px);
        border-radius: 16px;
        padding: 24px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        border: 1px solid rgba(255, 255, 255, 0.3);
        transition: all 0.3s ease;
      }

      .controls-section:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
      }

      .audio-controls {
        display: flex;
        gap: 15px;
        align-items: center;
        justify-content: center;
      }

      .control-btn {
        padding: 15px 25px;
        border: none;
        border-radius: 12px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        min-width: 120px;
      }

      .start-btn {
        background: linear-gradient(
          135deg,
          rgba(134, 239, 172, 0.8),
          rgba(187, 247, 208, 0.8)
        );
        color: #166534;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(134, 239, 172, 0.3);
        box-shadow: 0 4px 15px rgba(134, 239, 172, 0.2);
      }

      .start-btn:hover:not(:disabled) {
        transform: translateY(-2px);
        background: linear-gradient(
          135deg,
          rgba(134, 239, 172, 0.9),
          rgba(187, 247, 208, 0.9)
        );
        box-shadow: 0 8px 25px rgba(134, 239, 172, 0.3);
      }

      .stop-btn {
        background: linear-gradient(
          135deg,
          rgba(252, 165, 165, 0.8),
          rgba(254, 202, 202, 0.8)
        );
        color: #991b1b;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(252, 165, 165, 0.3);
        box-shadow: 0 4px 15px rgba(252, 165, 165, 0.2);
      }

      .stop-btn:hover:not(:disabled) {
        transform: translateY(-2px);
        background: linear-gradient(
          135deg,
          rgba(252, 165, 165, 0.9),
          rgba(254, 202, 202, 0.9)
        );
        box-shadow: 0 8px 25px rgba(252, 165, 165, 0.3);
      }

      .control-btn:disabled {
        background: #e2e8f0;
        color: #94a3b8;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
        border: 1px solid #cbd5e1;
      }

      .status {
        text-align: center;
        margin-top: 15px;
        padding: 10px;
        border-radius: 8px;
        font-weight: 500;
      }

      .status.ready {
        background: #dcfce7;
        color: #166534;
        border: 1px solid #bbf7d0;
      }

      .status.recording {
        background: #fef3c7;
        color: #92400e;
        border: 1px solid #fde68a;
      }

      .status.processing {
        background: #dbeafe;
        color: #1d4ed8;
        border: 1px solid #bfdbfe;
      }

      .status.error {
        background: #fee2e2;
        color: #991b1b;
        border: 1px solid #fecaca;
      }

      .finish-btn {
        width: 100%;
        padding: 15px;
        background: linear-gradient(
          135deg,
          rgba(147, 197, 253, 0.8),
          rgba(196, 181, 253, 0.8)
        );
        color: #4c1d95;
        border: 1px solid rgba(147, 197, 253, 0.3);
        border-radius: 16px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        margin-top: 20px;
        transition: all 0.3s ease;
        backdrop-filter: blur(10px);
        box-shadow: 0 4px 15px rgba(147, 197, 253, 0.2);
      }

      .finish-btn:hover {
        transform: translateY(-3px);
        background: linear-gradient(
          135deg,
          rgba(147, 197, 253, 0.9),
          rgba(196, 181, 253, 0.9)
        );
        box-shadow: 0 12px 35px rgba(147, 197, 253, 0.3);
      }

      @media (max-width: 1200px) {
        .study-container {
          grid-template-columns: 1fr 1fr;
        }
        .right-panel {
          grid-column: 1 / -1;
        }
      }

      @media (max-width: 1024px) {
        .study-container {
          grid-template-columns: 1fr;
          height: auto;
        }
      }
    </style>
  </head>
  <body>
    <div class="floating-orb orb-1"></div>
    <div class="floating-orb orb-2"></div>
    <div class="floating-orb orb-3"></div>
    <div class="header">
      <div class="header-content">
        <div class="logo">
          <h1>SPEEK-SEE-PIC!</h1>
        </div>
        <div class="session-info">
          <div class="timer" id="timer">00:00</div>
          <a href="/categories" class="back-btn">← Back to Categories</a>
        </div>
      </div>
    </div>

    <div class="container">
      <div class="page-title">
        <h2>English Learning Session</h2>
        <p>Describe the image and practice your English conversation skills</p>
      </div>
    </div>

    <div class="study-container">
      <div class="left-panel">
        <div class="image-section">
          <div class="section-title">Original Image</div>
          <img
            id="original-image"
            class="original-image"
            src=""
            alt="Study image"
          />
        </div>
      </div>

      <div class="center-panel">
        <div class="conversation-section">
          <div class="section-title">Conversation with Nova Tutor</div>
          <div class="chat-container" id="chat-container">
            <div class="message assistant">
              <div class="role-label">NOVA TUTOR</div>
              <div>
                Hello! I'm your English tutor. Look at the image on the left and
                start describing what you see. I'll help you make your
                description more detailed and specific!
              </div>
            </div>
          </div>
        </div>

        <div class="controls-section">
          <div class="section-title">Voice Controls</div>
          <div class="audio-controls">
            <button id="start-btn" class="control-btn start-btn">
              🎤 Start Speaking
            </button>
            <button id="stop-btn" class="control-btn stop-btn" disabled>
              ⏹️ Stop
            </button>
          </div>
          <div id="status" class="status ready">
            Ready to start! Click "Start Speaking" and describe the image.
          </div>
          <button id="finish-btn" class="finish-btn">
            ✅ Finish Session & Get Evaluation
          </button>
        </div>
      </div>

      <div class="right-panel">
        <div class="generated-image-section">
          <div class="section-title">
            🎨 AI Generated Image (Real-time from Your Speech)
          </div>
          <div class="generated-image-placeholder" id="generated-placeholder">
            🎤 Start speaking to automatically generate images based on your
            description!
          </div>
          <img
            id="generated-image"
            class="generated-image"
            src=""
            alt="Generated image"
          />
        </div>
      </div>
    </div>

    <script>
      // 전역 변수
      let socket;
      let audioContext;
      let audioStream;
      let processor;
      let sourceNode;
      let isStreaming = false;
      let sessionInitialized = false;
      let startTime;
      let timerInterval;
      let conversationHistory = [];
      let currentImage = null;
      let samplingRatio = 1;
      const TARGET_SAMPLE_RATE = 16000;
      const isFirefox = navigator.userAgent.toLowerCase().includes("firefox");

      // 이미지 생성 관련 변수
      let userMessages = [];
      let imageGenerationTimer;
      let isGeneratingImage = false;

      // Set을 이용한 중복 메시지 방지
      let lastProcessedMessages = new Set();

      console.log("🔧 Frontend: Image generation variables initialized");

      // 페이지 로드 시 초기화
      document.addEventListener("DOMContentLoaded", async () => {
        // 로그인 확인
        const user = JSON.parse(localStorage.getItem("user") || "null");
        if (!user) {
          window.location.href = "/login";
          return;
        }

        // URL에서 카테고리 가져오기
        const urlParams = new URLSearchParams(window.location.search);
        const categoryId =
          urlParams.get("category") || localStorage.getItem("selectedCategory");

        if (!categoryId) {
          window.location.href = "/categories";
          return;
        }

        // 초기화
        await initializeStudySession(categoryId);
        setupEventListeners();
        startTimer();
      });

      async function initializeStudySession(categoryId) {
        try {
          // 카테고리별 이미지 가져오기
          console.log(`Fetching images for category: ${categoryId}`);
          const response = await fetch(`/api/categories/${categoryId}/images`);
          
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          
          const result = await response.json();
          console.log('API response:', result);

          if (result.success && result.data && result.data.image) {
            currentImage = {
              imageId: result.data.image.imageId,
              url: `https://d1d6oeec7imlh5.cloudfront.net/${result.data.image.s3ImageKey}`,
              description: result.data.image.description,
              difficulty: result.data.image.difficulty,
              category: result.data.category,
              categoryId: categoryId,
            };
            
            console.log('Current image:', currentImage);
            displayImage(currentImage);

            // Socket.IO 연결
            socket = io();
            setupSocketEvents();

            // 오디오 초기화
            await initAudio();

            // 공식 AudioPlayer 초기화
            const { AudioPlayer } = await import("/js/AudioPlayer.js");
            window.audioPlayer = new AudioPlayer();
            await window.audioPlayer.start();
            console.log("Official AudioPlayer initialized");
          } else {
            console.error('Invalid API response:', result);
            throw new Error(`Failed to load image: ${result.error || 'Unknown error'}`);
          }
        } catch (error) {
          console.error("Error initializing study session:", error);
          document.getElementById("status").textContent =
            `Error loading study session: ${error.message}`;
          document.getElementById("status").className = "status error";
        }
      }

      function displayImage(imageData) {
        const img = document.getElementById("original-image");
        
        img.onload = function() {
          console.log('Image loaded successfully:', imageData.url);
        };
        
        img.onerror = function() {
          console.error('Failed to load image:', imageData.url);
          document.getElementById("status").textContent = "Failed to load image";
          document.getElementById("status").className = "status error";
        };
        
        console.log('Setting image source:', imageData.url);
        img.src = imageData.url;
      }

      function setupSocketEvents() {
        socket.on("connect", () => {
          console.log("Connected to server");
          document.getElementById("status").textContent =
            "Connected! Ready to start.";
          document.getElementById("status").className = "status ready";
        });

        socket.on("textOutput", (data) => {
          console.log("Text output:", data);

          // interrupted 메시지는 UI에 표시하지 않음
          if (
            data.content &&
            data.content.toLowerCase().includes("interrupted")
          ) {
            console.log("Filtered out interrupted message:", data.content);
            return;
          }

          // JSON 형태의 interrupted 메시지 필터링
          try {
            const parsed = JSON.parse(data.content);
            if (parsed.interrupted === true) {
              console.log("Filtered out JSON interrupted message");
              return;
            }
          } catch (e) {
            // JSON이 아닌 경우 무시하고 계속 진행
          }

          // AI 메시지만 추가 (사용자 메시지는 userTextDetected에서 처리)
          // Set을 이용한 중복 방지는 addMessageToChat 내부에서 처리
          if (data.role === "ASSISTANT") {
            addMessageToChat("assistant", data.content);
          }
          // USER 메시지는 무시 (중복 방지)
        });

        socket.on("audioOutput", (data) => {
          if (data.content && window.audioPlayer) {
            playAudio(data.content);
          }
        });

        socket.on("contentStart", (data) => {
          console.log("Content start:", data);
        });

        socket.on("contentEnd", (data) => {
          console.log("Content end:", data);

          // Java 샘플과 동일한 barge-in 처리
          if (data.type === "TEXT") {
            if (
              data.stopReason &&
              data.stopReason.toUpperCase() === "END_TURN"
            ) {
              console.log("Turn ended normally");
            } else if (
              data.stopReason &&
              data.stopReason.toUpperCase() === "INTERRUPTED"
            ) {
              console.log("AI speech interrupted by user (barge-in)");
              if (window.audioPlayer) {
                window.audioPlayer.bargeIn();
              }
            }
          }
        });

        socket.on("error", (error) => {
          console.error("Socket error:", error);
          document.getElementById("status").textContent =
            "Error: " + error.message;
          document.getElementById("status").className = "status error";
        });

        // 사용자 텍스트 감지 수신 (Set을 이용한 중복 방지)
        socket.on("userTextDetected", (data) => {
          console.log("👤 Frontend: User text detected:", data.text);
          console.log("📝 Frontend: Full buffer:", data.fullBuffer);

          // Set을 이용한 중복 방지는 addMessageToChat 내부에서 처리
          addMessageToChat("user", data.text);
        });

        // 이미지 생성 결과 수신
        socket.on("imageGenerated", (data) => {
          console.log("🎨 Frontend: Image generation result received:", data);
          console.log("🔧 Frontend: Setting isGeneratingImage to false");
          isGeneratingImage = false;

          if (data.success) {
            console.log("✅ Frontend: Image generated successfully!");
            if (data.isAutoGenerated) {
              console.log("🤖 Frontend: Auto-generated image");
              displayGeneratedImage(data.imageUrl, data.originalText, true);
              showAutoGenerationNotice(data.originalText);
            } else {
              console.log("👤 Frontend: Manual generated image");
              displayGeneratedImage(data.imageUrl, data.prompt);
            }
          } else {
            console.error("❌ Frontend: Image generation failed:", data.error);
            showImageGenerationError();
          }

          console.log("🔧 Frontend: Ready for next image generation");
        });
      }

      async function initAudio() {
        try {
          document.getElementById("status").textContent =
            "Requesting microphone access...";

          audioStream = await navigator.mediaDevices.getUserMedia({
            audio: {
              echoCancellation: true,
              noiseSuppression: true,
              autoGainControl: true,
            },
          });

          // 공식 샘플 코드와 동일한 설정
          const isFirefox = navigator.userAgent
            .toLowerCase()
            .includes("firefox");

          if (isFirefox) {
            audioContext = new AudioContext();
          } else {
            audioContext = new AudioContext({
              sampleRate: 16000,
            });
          }

          const samplingRatio = audioContext.sampleRate / 16000;
          console.log(
            `AudioContext sampleRate: ${audioContext.sampleRate}, samplingRatio: ${samplingRatio}`
          );

          document.getElementById("status").textContent =
            'Microphone ready! Click "Start Speaking" to begin.';
          document.getElementById("status").className = "status ready";
        } catch (error) {
          console.error("Error accessing microphone:", error);
          document.getElementById("status").textContent =
            "Error: " + error.message;
          document.getElementById("status").className = "status error";
        }
      }

      function setupEventListeners() {
        document
          .getElementById("start-btn")
          .addEventListener("click", startRecording);
        document
          .getElementById("stop-btn")
          .addEventListener("click", stopRecording);
        document
          .getElementById("finish-btn")
          .addEventListener("click", finishSession);
      }

      async function startRecording() {
        if (isStreaming) return;

        try {
          // 세션 초기화
          if (!sessionInitialized) {
            await initializeNovaSession();
          }

          // audioContext가 없으면 오디오 재초기화
          if (!audioContext || !audioStream) {
            console.log("🔄 Re-initializing audio...");
            await initAudio();
          }

          // 오디오 처리 시작 - 작은 버퍼로 지연시간 최소화
          sourceNode = audioContext.createMediaStreamSource(audioStream);
          processor = audioContext.createScriptProcessor(1024, 1, 1);

          processor.onaudioprocess = (e) => {
            if (!isStreaming) return;

            const inputData = e.inputBuffer.getChannelData(0);
            const numSamples = Math.round(inputData.length / samplingRatio);
            const pcmData = isFirefox
              ? new Int16Array(numSamples)
              : new Int16Array(inputData.length);

            // 공식 샘플 코드와 동일한 처리
            if (isFirefox) {
              for (let i = 0; i < inputData.length; i++) {
                pcmData[i] =
                  Math.max(-1, Math.min(1, inputData[i * samplingRatio])) *
                  0x7fff;
              }
            } else {
              for (let i = 0; i < inputData.length; i++) {
                pcmData[i] = Math.max(-1, Math.min(1, inputData[i])) * 0x7fff;
              }
            }

            const base64Data = arrayBufferToBase64(pcmData.buffer);
            socket.emit("audioInput", base64Data);
          };

          sourceNode.connect(processor);
          processor.connect(audioContext.destination);

          isStreaming = true;
          document.getElementById("start-btn").disabled = true;
          document.getElementById("stop-btn").disabled = false;
          document.getElementById("status").textContent =
            "Listening... Describe what you see!";
          document.getElementById("status").className = "status recording";
        } catch (error) {
          console.error("Error starting recording:", error);
          document.getElementById("status").textContent =
            "Error: " + error.message;
          document.getElementById("status").className = "status error";
        }
      }

      function stopRecording() {
        if (!isStreaming) return;

        isStreaming = false;

        if (processor) {
          processor.disconnect();
          sourceNode.disconnect();
        }

        // 사용자가 수동으로 중단할 때 barge-in 처리
        if (window.audioPlayer) {
          window.audioPlayer.bargeIn();
        }

        document.getElementById("start-btn").disabled = false;
        document.getElementById("stop-btn").disabled = true;
        document.getElementById("status").textContent = "Processing...";
        document.getElementById("status").className = "status processing";

        socket.emit("stopAudio");
      }

      async function initializeNovaSession() {
        if (sessionInitialized) return;

        try {
          const contextualPrompt = `You are an English conversation tutor helping a user describe an image.

Image Context: ${currentImage.description}
Guiding Questions: ${currentImage.guidingQuestions ? currentImage.guidingQuestions.join(", ") : "What do you see in this image?"}

Your role:
- Ask ONE specific follow-up question at a time
- Focus on visual details they haven't mentioned
- Keep responses short (1-2 sentences)
- Be encouraging and supportive
- Help them use more descriptive vocabulary

Start by encouraging them to describe what they see.`;

          socket.emit("promptStart");
          socket.emit("systemPrompt", contextualPrompt);
          socket.emit("audioStart");

          sessionInitialized = true;
          document.getElementById("status").textContent =
            "Session initialized! Ready to start.";
          document.getElementById("status").className = "status ready";

          // 이미지 생성 타이머 시작
          startImageGeneration();
        } catch (error) {
          console.error("Failed to initialize Nova session:", error);
          throw error;
        }
      }

      function addMessageToChat(role, message) {
        // 빈 메시지나 interrupted 메시지 필터링
        if (
          !message ||
          message.trim() === "" ||
          message.toLowerCase().includes("interrupted") ||
          message === '{ "interrupted" : true }' ||
          message === '{"interrupted":true}'
        ) {
          console.log("Filtered message:", message);
          return;
        }

        // Set을 이용한 중복 메시지 방지
        const messageKey = `${role}:${message.trim()}`;
        if (lastProcessedMessages.has(messageKey)) {
          console.log("Duplicate message filtered with Set:", messageKey);
          return;
        }

        // 메시지 키를 Set에 추가
        lastProcessedMessages.add(messageKey);

        // Set 크기 제한 (메모리 절약)
        if (lastProcessedMessages.size > 20) {
          const firstKey = Array.from(lastProcessedMessages)[0];
          lastProcessedMessages.delete(firstKey);
        }

        const chatContainer = document.getElementById("chat-container");
        const messageDiv = document.createElement("div");
        messageDiv.className = `message ${role}`;

        const roleLabel = document.createElement("div");
        roleLabel.className = "role-label";
        roleLabel.textContent = role === "assistant" ? "NOVA TUTOR" : "YOU";

        const content = document.createElement("div");
        content.textContent = message;

        messageDiv.appendChild(roleLabel);
        messageDiv.appendChild(content);
        chatContainer.appendChild(messageDiv);

        // 스크롤을 맨 아래로
        chatContainer.scrollTop = chatContainer.scrollHeight;

        // 대화 기록에 추가
        conversationHistory.push({
          role: role,
          message: message,
          timestamp: new Date().toISOString(),
        });

        console.log(
          `✅ Message added to chat: ${role} - ${message.substring(0, 50)}...`
        );
      }

      // 자동 이미지 생성 시작 (서버에서 사용자 발화 종료 시 자동 처리)
      function startImageGeneration() {
        console.log(
          "Auto image generation enabled - images will be generated automatically when user stops speaking"
        );
      }

      // Nova Canvas로 이미지 생성
      function generateImageFromUserMessages(prompt) {
        if (isGeneratingImage) {
          console.log("Image generation already in progress, skipping...");
          return;
        }

        isGeneratingImage = true;
        console.log("Generating image with prompt:", prompt);

        // 생성 중 표시
        showImageGenerationProgress();

        // Socket을 통해 이미지 생성 요청
        socket.emit("generateImage", { prompt: prompt });
      }

      // 생성된 이미지 표시
      function displayGeneratedImage(imageUrl, prompt, isAuto = false) {
        console.log("🖼️ Frontend: Displaying generated image...");
        console.log("🔗 Frontend: Image URL length:", imageUrl.length);
        console.log("📝 Frontend: Prompt:", prompt);

        const placeholder = document.getElementById("generated-placeholder");
        const generatedImg = document.getElementById("generated-image");

        placeholder.style.display = "none";
        generatedImg.src = imageUrl;
        generatedImg.style.display = "block";

        // 생성된 이미지 URL 저장
        currentImage.generatedImageUrl = imageUrl;
        currentImage.generatedPrompt = prompt;
        currentImage.isAutoGenerated = isAuto;

        console.log(
          `✅ Frontend: Generated image displayed successfully (${isAuto ? "auto" : "manual"})`
        );
      }

      // 자동 생성 알림 표시
      function showAutoGenerationNotice(userText) {
        const chatContainer = document.getElementById("chat-container");
        const noticeDiv = document.createElement("div");
        noticeDiv.className = "message thinking";

        const content = document.createElement("div");
        content.innerHTML = `🎨 <strong>AI Image Generated!</strong><br>Based on: "${userText}"`;

        noticeDiv.appendChild(content);
        chatContainer.appendChild(noticeDiv);

        // 스크롤을 맨 아래로
        chatContainer.scrollTop = chatContainer.scrollHeight;

        // 3초 후 자동 삭제
        setTimeout(() => {
          if (noticeDiv.parentNode) {
            noticeDiv.parentNode.removeChild(noticeDiv);
          }
        }, 3000);
      }

      // 이미지 생성 진행 상태 표시
      function showImageGenerationProgress() {
        const placeholder = document.getElementById("generated-placeholder");
        placeholder.innerHTML =
          "🎨 Generating AI image based on your description...";
        placeholder.style.color = "#667eea";
      }

      // 이미지 생성 오류 표시
      function showImageGenerationError() {
        const placeholder = document.getElementById("generated-placeholder");
        placeholder.innerHTML =
          "❌ Failed to generate image. Keep describing and we'll try again!";
        placeholder.style.color = "#ef4444";

        // 3초 후 원래 메시지로 복원
        setTimeout(() => {
          placeholder.innerHTML =
            "Start describing the image above to generate an AI image based on your words!";
          placeholder.style.color = "#64748b";
        }, 3000);
      }

      function arrayBufferToBase64(buffer) {
        const binary = [];
        const bytes = new Uint8Array(buffer);
        for (let i = 0; i < bytes.byteLength; i++) {
          binary.push(String.fromCharCode(bytes[i]));
        }
        return btoa(binary.join(""));
      }

      function playAudio(base64Data) {
        try {
          // 공식 샘플 코드와 동일한 방식으로 처리
          const binaryString = window.atob(base64Data);
          const bytes = new Uint8Array(binaryString.length);
          for (let i = 0; i < binaryString.length; i++) {
            bytes[i] = binaryString.charCodeAt(i);
          }

          const int16Array = new Int16Array(bytes.buffer);
          const float32Array = new Float32Array(int16Array.length);
          for (let i = 0; i < int16Array.length; i++) {
            float32Array[i] = int16Array[i] / 32768.0;
          }

          if (window.audioPlayer && float32Array.length > 0) {
            window.audioPlayer.playAudio(float32Array);
          }
        } catch (error) {
          console.error("Error processing audio data:", error);
        }
      }

      function startTimer() {
        startTime = Date.now();
        timerInterval = setInterval(() => {
          const elapsed = Date.now() - startTime;
          const minutes = Math.floor(elapsed / 60000);
          const seconds = Math.floor((elapsed % 60000) / 1000);
          document.getElementById("timer").textContent =
            `${minutes.toString().padStart(2, "0")}:${seconds.toString().padStart(2, "0")}`;
        }, 1000);
      }

      function finishSession() {
        // 타이머 정지
        if (timerInterval) {
          clearInterval(timerInterval);
        }

        // 세션 데이터 저장
        const sessionData = {
          image: currentImage,
          conversationHistory: conversationHistory,
          duration: Date.now() - startTime,
          timestamp: new Date().toISOString(),
        };

        localStorage.setItem("sessionData", JSON.stringify(sessionData));

        // 평가 페이지로 이동
        window.location.href = "/evaluation";
      }

      // 페이지 언로드 시 정리
      window.addEventListener("beforeunload", () => {
        if (timerInterval) {
          clearInterval(timerInterval);
        }

        if (socket) {
          socket.disconnect();
        }
      });
    </script>
  </body>
</html>
